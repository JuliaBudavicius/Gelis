<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="js/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/cores.js"></script>
    <script src="https://kit.fontawesome.com/6f2d70ffaf.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kulim+Park:wght@200;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="img/icone.png" type="image/x-icon">
    <script src="js/validacaoNPJ.js"></script>
    <title>Painel de Controle</title>
</head>

<body>
    <div id="absoluto" class="absoluto">
        <div class="sair">
            <img class="iconSair" src="img/icone.png" alt="">
            <p class="tituloSair">Deseja mesmo sair?</p>
            <div class="lado">
                <button class="btnCancelar" onclick="fechar()">Cancelar</button>
                <button class="btnSair" onclick="logoff()"> Sair</button>
            </div>
        </div>
    </div>
    <section id="dashboardSec" class="dashboard">
        <div class="absolute none" id="abs">
            <i class="fa fa-times fa-2x" onclick="hide()"></i>
            <div class="boxTitulo">
                <p class="txtInfo">Informações Principais</p>
            </div>
            <div class="boxSup">
                <div class="verti">
                    <p class="titInfo">Hostname</p>
                    <p id="hostname" class="Info"></p>
                </div>
                <div class="verti">
                    <p class="titInfo">Temperatura da GPU</p>
                    <p id="tempGpu" class="InfoRed"></p>
                </div>
                <div class="verti">
                    <p class="titInfo">Temperatura da CPU</p>
                    <p id="tempCpu" class="Info"></p>
                </div>
                <div class="verti">
                    <p class="titInfo">Uso da Memória RAM</p>
                    <div class="grafico">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="inf">
                <div class="esq">
                    <div class="boxTituloP">
                        <p class="txtInfo">Grafíco de uso dos recursos</p>
                    </div>
                    <div class="listProc">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
                <div class="dir">
                    <div>
                        <div class="boxTituloS">
                            <p class="txtInfo">Status da máquina</p>
                        </div>
                        <div class="divstatus">
                            <i id="iconeaAlert" class="fas fa-3x"></i>
                            <p id="txtAlert" class="txtAlerta"></p>
                        </div>
                    </div>
                    <div>
                        <div class="boxTituloS">
                            <p class="txtInfo">Lista de processos</p>
                        </div>
                        <div class="ultReg">
                            <div class="titulosProc">
                                <p class="titProc">Nome</p>
                                <p class="titProc">CPU</p>
                                <p class="titProc">PID</p>
                            </div>
                            <div class="painelProc" id="painelProc"></div>
                            <!-- <div class="linha">
                                <p class="infoProc">Discord</p>
                                <p class="infoProc">22%</p>
                                <p class="infoProc">34232</p>
                            </div>
                            <div class="linha">
                                <p class="infoProc">Discord</p>
                                <p class="infoProc">22%</p>
                                <p class="infoProc">34232</p>
                            </div>
                            <div class="linha">
                                <p class="infoProc">Discord</p>
                                <p class="infoProc">22%</p>
                                <p class="infoProc">34232</p>
                            </div> -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="menulateral">
            <div class="topo">
                <img class="logo" src="img/logo.png" alt="">
                <img class="iconempresa" src="img/icon.png" alt="">
                <p class="nomeempresa" id="nome_EmpresaD"></p>
                <p class="cnpjempresa" id="cnpj_EmpresaD">CNPJ: </p>
            </div>
            <div class="botoes">
                <button class="btn destaque" onclick="dashboard()"><i class="fas fa-tv"></i>Computadores</button>
                <button class="btn" onclick="config()"><i class="fas fa-cog"></i>Configurações</button>
                <button class="btn" onclick="usuario()"><i class="fas fa-user-plus"></i>Usuário</button>
            </div>
            <button class="btn btn-sair" onclick="sair()"><i class="fas fa-sign-out-alt"></i>Sair</button>
        </div>
        <div class="ladoEsquerdo">
            <div class="superior">
                <div class="pesquisa">
                    <input type="text" class="pesquisacampo" placeholder="Pesquisar">
                    <button type="submit" class="pesquisabtn">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
                <div class="notifica">
                    <i class="far fa-bell"></i>
                    <div class="numero">3</div>
                </div>
            </div>
            <div class="inferior">
                <p class="tituloStatus">Status dos computadores</p>
                <div class="boxes">
                    <div class="box">
                        <p class="txt Normal">Normal</p>
                        <p class="qtdeComp" id="qtdNormal"></p>
                    </div>
                    <div class="box">
                        <p class="txt Alerta">Alerta</p>
                        <p class="qtdeComp" id="qtdAlerta"></p>
                    </div>
                    <div class="box">
                        <p class="txt Critico">Crítico</p>
                        <p class="qtdeComp" id="qtdCritico"></p>
                    </div>
                </div>
                <div class="computadores">
                    <p class="tituloStatus">Computadores</p>
                    <div id="boxes" class="boxes">
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="configSec" class="config none">
        <div class="menulateral">
            <div class="topo">
                <img class="logo" src="img/logo.png" alt="">
                <img class="iconempresa" src="img/icon.png" alt="">
                <p class="nomeempresa" id="nome_EmpresaC"></p>
                <p class="cnpjempresa" id="cnpj_EmpresaC">CNPJ: </p>
            </div>
            <div class="botoes">
                <button class="btn" onclick="dashboard()"><i class="fas fa-tv"></i>Computadores</button>
                <button class="btn destaque" onclick="config()"><i class="fas fa-cog"></i>Configurações</button>
                <button class="btn" onclick="usuario()"><i class="fas fa-user-plus"></i>Usuário</button>
            </div>
            <button class="btn btn-sair" onclick="sair()"><i class="fas fa-sign-out-alt"></i>Sair</button>
        </div>
        <div class="ladoEsquerdo">
            <div class="configuracoes">
                <p class="tituloConfig">CONFIGURAÇÕES</p>
                <form id="form_atualizar" method="post" onsubmit="return atualizar()">
                    <div class="forms">
                        <div>
                            <p>Nome empresa</p>
                            <input name="nomeEmpresa" type="text" id="nomeEmpresaInput">
                        </div>
                        <div>
                            <p>Email</p>
                            <input name="emailEmpresa" type="text" id="emailEmpresaInput">
                        </div>
                    </div>
                    <div class="forms">
                        <div>
                            <p>CNPJ</p>
                            <input onkeyup="validarcnpj()" name="cnpjEmpresa" type="text" id="cnpjEmpresaInput">
                        </div>
                        <div>
                            <p>WhatsApp</p>
                            <input name="whatsEmpresa" type="text" id="whatsEmpresaInput">
                        </div>
                    </div>
                    <div class="linhaConfig"></div>
                    <div class="forms">
                        <div>
                            <p>CEP</p>
                            <input name="cepEmpresa" type="text" id="cepEmpresaInput">
                        </div>
                        <div>
                            <p>Estado</p>
                            <input name="estadoEmpresa" type="text" id="estadoEmpresaInput">
                        </div>
                    </div>
                    <div class="forms">
                        <div>
                            <p>Cidade</p>
                            <input name="cidadeEmpresa" type="text" id="cidadeEmpresaInput">
                        </div>
                        <div>
                            <p>Logradouro</p>
                            <input name="logradouroEmpresa" type="text" id="logradouroEmpresaInput">
                        </div>
                    </div>
                    <div class="linhaConfig"></div>
                    <div class="slack">
                        <p>Url Slack</p>
                        <input name="urlSlack" type="text" id="urlSlackInput">
                    </div>
                    <button class="btnSave">Salvar alterações</button>
                </form>
            </div>
        </div>
    </section>
    <section id="novoUsu" class="novoUsu none">
        <div class="menulateral">
            <div class="topo">
                <img class="logo" src="img/logo.png" alt="">
                <img class="iconempresa" src="img/icon.png" alt="">
                <p class="nomeempresa" id="nome_EmpresaN"></p>
                <p class="cnpjempresa" id="cnpj_EmpresaN">CNPJ: </p>
            </div>
            <div class="botoes">
                <button class="btn" onclick="dashboard()"><i class="fas fa-tv"></i>Computadores</button>
                <button class="btn" onclick="config()"><i class="fas fa-cog"></i>Configurações</button>
                <button class="btn destaque" onclick="usuario()"><i class="fas fa-user-plus"></i>Usuário</button>
            </div>
            <button class="btn btn-sair" onclick="sair()"><i class="fas fa-sign-out-alt"></i>Sair</button>
        </div>
        <div class="ladoEsquerdo">
            <div class="superior">
                <div class="pesquisa">
                    <input type="text" class="pesquisacampo" placeholder="Pesquisar">
                    <button type="submit" class="pesquisabtn">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
                <div class="notifica">
                    <i class="far fa-bell"></i>
                    <div class="numero">3</div>
                </div>
            </div>
            <div class="inferior">
                <div class="funcUsuarios">
                    <div class="txtCentr">
                        <p onclick="abrirAdd()"><i class="fa fa-plus-circle" aria-hidden="true"></i>Novo Usuário</p>
                        <p onclick="abrirDelet()"><i class="fa fa-minus-circle" aria-hidden="true"></i>Remover Usuário
                        </p>
                        <p onclick="abrirEdit()"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>Editar Usuário
                        </p>
                    </div>
                </div>
                <div class="tituloUsuarios">
                    <div class="txtCentr2">
                        <p>Nome Completo</p>
                        <p>E-mail</p>
                        <p>Hostname</p>
                    </div>
                </div>
                <div class="infoUsuarios">
                    <div id="linhasUsuarios" class="linhasUsuarios">
                    </div>
                </div>
            </div>

    </section>
    <div id="addUsu" class="absolutoAdd">
        <div class="fundoAdd">
            <p class="tituloAdd">
                <i class="fa fa-user-plus" aria-hidden="true"></i>
                Novo Usuário
            </p>
            <div>
                <form class="formAdd" id="form_add">
                    <div class="agrupa">
                        <div class="esquerdaAdd">
                            <p>Primeiro nome</p>
                            <input name="nomeResp" type="text">
                        </div>
                        <div>
                            <p>Sobrenome</p>
                            <input name="sobrenomeResp" type="text">
                        </div>
                    </div>
                    <div class="agrupa">
                        <div class="esquerdaAdd">
                            <p>E-mail</p>
                            <input name="emailFunc" type="text">
                        </div>
                        <div>
                            <p>Hostname</p>
                            <input name="hostname" type="text">
                        </div>
                    </div>
                    <div class="agrupa">
                        <div class="esquerdaAdd">
                            <p>Login</p>
                            <input name="loginMaquina" type="text">
                        </div>
                        <div>
                            <p>Senha</p>
                            <input name="senhaMaquina" type="password">
                        </div>
                    </div>
                </form>
                <div class="btnsAdd">
                    <button class="btnCriar" onclick="adicionar()">CRIAR</button>
                    <button class="btnCancelarAdd" onclick="cancelarAdd()">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>
    <div id="editUsu" class="absolutoAdd">
        <div class="fundoAdd">
            <p class="tituloAdd">
                <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                Editar Usuário
            </p>
            <div>
                <form class="formAdd" id="form_edit">
                    <div class="agrupa">
                        <div class="esquerdaAdd">
                            <p>Primeiro nome</p>
                            <input id="nomeEdit" name="nomeEdit" type="text">
                        </div>
                        <div>
                            <p>Sobrenome</p>
                            <input id="sobrenomeEdit" name="sobrenomeEdit" type="text">
                        </div>
                    </div>
                    <div class="agrupa">
                        <div class="esquerdaAdd">
                            <p>E-mail</p>
                            <input id="emailEdit" name="emailEdit" type="text">
                        </div>
                        <div>
                            <p>Hostname</p>
                            <input id="hostnameEdit" name="hostnameEdit" type="text">
                        </div>
                    </div>
                    <div class="agrupa">
                        <div class="esquerdaAdd">
                            <p>Login</p>
                            <input id="loginEdit" name="loginEdit" type="text">
                        </div>
                        <div>
                            <p>Senha</p>
                            <input id="senhaEdit" name="senhaEdit" type="password">
                        </div>
                    </div>
                </form>
                <div class="btnsAdd">
                    <button class="btnCriar" onclick="editar()">EDITAR</button>
                    <button class="btnCancelarAdd" onclick="cancelarEdit()">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    let proximaAtualizacao;
    window.onload = verificar_autenticacao();
    var cont = 0;
    var estado3 = "";
    function editar() {
        var group = document.getElementsByName('group');
        for (var i = 0; i < group.length; i++) {
            if (group[i].checked) {
                var idFuncionario = group[i].value;
                var formEdit = new URLSearchParams(new FormData(form_edit));
                fetch(`/funcionarios/atualizar/${idFuncionario}`, {
                    method: "POST",
                    body: formEdit
                }).then(function (resultado) {
                    if (resultado.ok) {
                        console.log('Atualizado com sucesso');
                        window.location.href = 'dashboard.html';
                    } else {
                        console.log('Erro de atualização!');
                        response.text().then(function (resultado) {});
                    }
                });

                return false;
            }
        }
    }

    function abrirDelet() {
        var group = document.getElementsByName('group');
        for (var i = 0; i < group.length; i++) {
            if (group[i].checked) {
                var idFuncionario = group[i].value;
                fetch(`/funcionarios/deletar/${idFuncionario}`, {
                        method: 'DELETE'
                    })
                    .then(function (response) {
                        if (response.ok) {
                            window.location.href = 'dashboard.html';
                        } else {
                            console.log('Erro ao deletar!');
                            response.text().then(function (resposta) {});
                        }
                    });
            }
        }
    }

    function adicionar() {
        var idEmpresa = sessionStorage.idEmpresa;
        var addUser = new URLSearchParams(new FormData(form_add));
        fetch(`/funcionarios/cadastrar/${idEmpresa}`, {
            method: "POST",
            body: addUser
        }).then(function (response) {
            if (response.ok) {
                window.location.href = 'dashboard.html';
            } else {
                console.log('Erro de cadastro!');
                response.text().then(function (resposta) {});
            }
        });
        return false;
    }

    function cancelarAdd() {
        addUsu.style.display = "none";
    }

    function abrirAdd() {
        addUsu.style.display = "flex";
    }

    function abrirEdit() {
        editUsu.style.display = "flex";
        var group = document.getElementsByName('group');
        for (var i = 0; i < group.length; i++) {
            if (group[i].checked) {
                var idFuncionario = group[i].value;
                fetch(`/funcionarios/cons-editar/${idFuncionario}`)
                    .then(resposta => {
                        if (resposta.ok) {
                            resposta.json().then(function (resposta) {
                                atualizarEditar(resposta);
                            });
                        } else {
                            console.error('Nenhum dado encontrado ou erro na API');
                        }
                    })
                    .catch(function (error) {
                        console.error(`Erro na obtenção das publicações: ${error.message}`);
                    });
            }
        }
    }

    function atualizarEditar(resposta) {
        caio = JSON.parse(JSON.stringify(resposta[0]));
        var hostname = caio.hostname;
        var nomeResp = caio.nomeResp;
        var sobrenome = caio.sobrenomeResp;
        var email = caio.emailFunc;
        var loginMaquina = caio.loginMaquina;
        var senhaMaquina = caio.senhaMaquina;

        var nomeInput = document.getElementById("nomeEdit");
        var sobrenomeInput = document.getElementById("sobrenomeEdit");
        var emailInput = document.getElementById("emailEdit");
        var hostnameInput = document.getElementById("hostnameEdit");
        var loginInput = document.getElementById("loginEdit");
        var senhaInput = document.getElementById("senhaEdit");

        nomeInput.value = `${nomeResp}`;
        sobrenomeInput.value = `${sobrenome}`;
        emailInput.value = `${email}`;
        hostnameInput.value = `${hostname}`;
        loginInput.value = `${loginMaquina}`;
        senhaInput.value = `${senhaMaquina}`;
    }

    function cancelarEdit() {
        editUsu.style.display = "none";
    }

    function obterFuncionarios() {
        var idEmpresa = sessionStorage.idEmpresa;
        fetch(`/funcionarios/${idEmpresa}`)
            .then(resposta => {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        console.log(`Dados dos funcionarios recebidos: ${JSON.stringify(resposta)}`);
                        atualizarFuncionarios(resposta);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção das publicações: ${error.message}`);
            });
    }

    function medias(tempCP, tempGP, usoRamP, id, iconEstado, box) {
        fetch(`/funcionarios/media/${id}`)
            .then(resposta => {
                if (resposta.ok) {
                    resposta.json().then(function (medias) {
                        caio = JSON.parse(JSON.stringify(medias[0]));
                        tempCP.innerHTML = caio.mediaCPU;
                        tempGP.innerHTML = caio.mediaGPU
                        usoRamP.innerHTML = caio.mediaRAM;
                        var estado3 = cores(usoRamP, tempGP, tempCP, iconEstado);
                        console.log(estado3);
                        tempCP.innerHTML += "°C";
                        tempGP.innerHTML += "°C";
                        box.setAttribute("onclick", `show(${id}, "${estado3}")`)
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção das publicações: ${error.message}`);
            });

    }

    function atualizarFuncionarios(funcionarios) {
        var painel = document.getElementById("linhasUsuarios");
        var painelBoxes = document.getElementById("boxes")
        for (let i = 0; i < funcionarios.length; i++) {
            var funcionario = funcionarios[i];
            var hostname = funcionario.Hostname;
            var nome = funcionario.Nome;
            var sobrenome = funcionario.Sobrenome;
            var email = funcionario.email;
            var id = funcionario.idMaquina;

            var divAux = document.createElement("div")
            var divLinha = document.createElement("div")
            var checkbox = document.createElement("input")
            var NomeP = document.createElement("p")
            var emailP = document.createElement("p")
            var HostnameP = document.createElement("p")

            var box = document.createElement("div");
            var computadorP = document.createElement("p");
            var responsavelP = document.createElement("p");
            var estadoP = document.createElement("p");
            var iconEstado = document.createElement("i");
            var divHoriz = document.createElement("div");
            var divVert = document.createElement("div");
            var divVert2 = document.createElement("div");
            var divVert3 = document.createElement("div");
            var CPUP = document.createElement("p");
            var RAMP = document.createElement("p");
            var GPUP = document.createElement("p");
            var tempCP = document.createElement("p");
            var tempGP = document.createElement("p");
            var usoRamP = document.createElement("p");
            tempCP.setAttribute('id', 'tempCP');
            usoRamP.setAttribute('id', 'usoRamP');
            tempGP.setAttribute('id', 'tempGP');
            medias(tempCP, tempGP, usoRamP, id, iconEstado, box);
            checkbox.type = "radio";
            checkbox.value = funcionario.idMaquina;
            checkbox.name = "group";
            NomeP.innerHTML = nome + " " + sobrenome;
            emailP.innerHTML = email;
            HostnameP.innerHTML = hostname;
            var numPC = i + 1;
            computadorP.innerHTML = "Computador " + numPC;
            responsavelP.innerHTML = nome;
            CPUP.innerHTML = "CPU";
            RAMP.innerHTML = "RAM";
            GPUP.innerHTML = "GPU";
            divAux.className = "divAux";
            checkbox.className = "checkbox";
            divLinha.className = "linhaUsuarios";
            NomeP.className = "nome";
            emailP.className = "email";

            box.className = "boxComp";
            computadorP.className = "nomeComp";
            responsavelP.className = "nomeResponsavel";
            CPUP.className = "txtHard";
            RAMP.className = "txtHard";
            GPUP.className = "txtHard";
            divVert.className = "vert";
            divVert2.className = "vert";
            divVert3.className = "vert";
            divHoriz.className = "horiz";
            tempCP.className = "temp";
            tempGP.className = "temp";
            usoRamP.className = "ram";

            divVert.appendChild(GPUP);
            divVert2.appendChild(CPUP);
            divVert3.appendChild(RAMP);
            divVert.appendChild(tempGP);
            divVert2.appendChild(tempCP);
            divVert3.appendChild(usoRamP);

            divHoriz.appendChild(divVert);
            divHoriz.appendChild(divVert2);
            divHoriz.appendChild(divVert3);
            box.appendChild(computadorP);
            box.appendChild(responsavelP);
            box.appendChild(estadoP);
            box.appendChild(iconEstado);
            box.appendChild(divHoriz);
            painelBoxes.appendChild(box);

            divAux.appendChild(NomeP);
            divAux.appendChild(emailP);
            divAux.appendChild(HostnameP);
            divLinha.appendChild(checkbox);
            divLinha.appendChild(divAux);
            painel.appendChild(divLinha);

        }
    }

    function sair() {
        absoluto.style = "display: flex;";
    }

    function fechar() {
        absoluto.style = "display: none;";
    }

    function dashboard() {
        configSec.classList.add('none');
        novoUsu.classList.add('none');
        dashboardSec.classList.remove('none');
    }

    function config() {
        configSec.classList.remove('none');
        dashboardSec.classList.add('none');
        novoUsu.classList.add('none');
    }

    function usuario() {
        configSec.classList.add('none');
        dashboardSec.classList.add('none');
        novoUsu.classList.remove('none');
    }

    function chart() {
        var ctx = document.getElementById('myChart').getContext('2d');
        window.myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0.0, 0.0],
                    backgroundColor: [
                        'rgb(255, 0, 0)',
                        'rgba(255, 255, 255, 0)'
                    ],
                    hoverOffset: 1
                }]
            },
            radius: 50
        });
    }

    function update(numero) {
        fetch(`/funcionarios/ram/${numero}`, {
                cache: 'no-store'
            }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (Registro) {
                        myChart.data.datasets[0].data.shift();
                        myChart.data.datasets[0].data.shift();
                        var resto = Registro.qntRAM - Registro.usoRAM;
                        myChart.data.datasets[0].data.push(Registro.usoRAM.toFixed(1));
                        myChart.data.datasets[0].data.push(resto.toFixed(1));
                        myChart.update();
                        console.log("O id é: " + numero);
                        obterDadosGraficoPrimeiraVez(numero);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function processos(numero) {
        fetch(`/funcionarios/processos/${numero}`, {
                cache: 'no-store'
            }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (processos) {
                        var painelProc = document.getElementById("painelProc");
                        for (let i = 0; i < processos.length; i++) {
                            var processo = processos[i];
                            var nome = processo.nomeProcesso;
                            var usoCPU = processo.usoCPU;
                            var pid = processo.PID;
                            var linha = document.createElement("div");
                            var nomeProc = document.createElement("p");
                            var usoCPUP = document.createElement("p");
                            var pidP = document.createElement("p");
                            nomeProc.innerHTML = nome;
                            usoCPUP.innerHTML = usoCPU + "%";
                            pidP.innerHTML = pid;
                            linha.setAttribute('id', 'linha');
                            linha.className = "linha";
                            nomeProc.className = "infoProc";
                            usoCPUP.className = "infoProc";
                            pidP.className = "infoProc";
                            linha.appendChild(nomeProc);
                            linha.appendChild(usoCPUP);
                            linha.appendChild(pidP);
                            painelProc.appendChild(linha);
                        }
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function remove() {
        for (let i = 0; i < 3; i++) {
            var linha = document.getElementById("linha");
            if (linha != null) {
                linha.remove();
            }
        }
    }

    function verificar_autenticacao() {
        var nome = document.getElementById('nomeEmpresaInput');
        var email = document.getElementById('emailEmpresaInput');
        var cnpj = document.getElementById('cnpjEmpresaInput');
        var whats = document.getElementById('whatsEmpresaInput');
        var cep = document.getElementById('cepEmpresaInput');
        var estado = document.getElementById('estadoEmpresaInput');
        var cidade = document.getElementById('cidadeEmpresaInput');
        var logradouro = document.getElementById('logradouroEmpresaInput');
        var urlSlack = document.getElementById('urlSlackInput');
        chart();
        let nomeEmpresa;
        let cnpjEmpresa;
        let emailEmpresa;
        let whatsEmpresa;
        let cepEmpresa;
        let estadoEmpresa;
        let cidadeEmpresa;
        let logradouroEmpresa;
        let urlSlackEmpresa;

        nomeEmpresa = sessionStorage.nomeEmpresa;
        cnpjEmpresa = sessionStorage.cnpjEmpresa;
        emailEmpresa = sessionStorage.emailEmpresa;
        whatsEmpresa = sessionStorage.whatsEmpresa;
        cepEmpresa = sessionStorage.cepEmpresa;
        estadoEmpresa = sessionStorage.estadoEmpresa;
        cidadeEmpresa = sessionStorage.cidadeEmpresa;
        logradouroEmpresa = sessionStorage.logradouroEmpresa;
        urlSlackEmpresa = sessionStorage.urlSlack;

        if (nomeEmpresa == undefined) {
            redirecionar_email();
        } else {
            obterFuncionarios();
            nome.value += `${nomeEmpresa}`;
            email.value += `${emailEmpresa}`;
            cnpj.value += `${cnpjEmpresa}`;
            whats.value += `${whatsEmpresa}`;
            cep.value += `${cepEmpresa}`;
            estado.value += `${estadoEmpresa}`;
            cidade.value += `${cidadeEmpresa}`;
            logradouro.value += `${logradouroEmpresa}`;
            urlSlack.value += `${urlSlackEmpresa}`;
            nome_EmpresaD.innerHTML += `${nomeEmpresa}`;
            nome_EmpresaC.innerHTML += `${nomeEmpresa}`;
            nome_EmpresaN.innerHTML += `${nomeEmpresa}`;
            cnpj_EmpresaD.innerHTML += `${cnpjEmpresa}`;
            cnpj_EmpresaC.innerHTML += `${cnpjEmpresa}`;
            cnpj_EmpresaN.innerHTML += `${cnpjEmpresa}`;

        }
        validar_sessao()
    }

    function validar_sessao() {
        var emailEmpresa = sessionStorage.emailEmpresa;
        fetch(`/empresas/sessao/${emailEmpresa}`, {
                cache: 'no-store'
            })
            .then(resposta => {
                if (resposta.ok) {
                    resposta.text().then(texto => {
                        console.log('Sessão :) ', texto);
                    });
                } else {
                    console.error('Sessão :.( ');
                    logoff();
                }
            });
    }

    function atualizar() {
        var nome = document.getElementById('nomeEmpresaInput');
        var cnpj = document.getElementById('cnpjEmpresaInput');
        var idEmpresa = sessionStorage.idEmpresa;
        var formulario1 = new URLSearchParams(new FormData(form_atualizar));
        fetch(`/empresas/atualizar/${idEmpresa}`, {
            method: "POST",
            body: formulario1
        }).then(function (resultado) {
            if (resultado.ok) {
                console.log('Atualizado com sucesso');
                nome_EmpresaD.innerHTML = `${nome.value}`;
                nome_EmpresaC.innerHTML = `${nome.value}`;
                nome_EmpresaN.innerHTML = `${nome.value}`;
                cnpj_EmpresaD.innerHTML = `CNPJ: ${cnpj.value}`;
                cnpj_EmpresaC.innerHTML = `CNPJ: ${cnpj.value}`;
                cnpj_EmpresaN.innerHTML = `CNPJ: ${cnpj.value}`;
                sessionStorage.nomeEmpresa = nome.value;
                sessionStorage.cnpjEmpresa = cnpj.value;

            } else {
                console.log('Erro de atualização!');
                response.text().then(function (resultado) {});
            }
        });

        return false;
    }

    function obterDadosGraficoPrimeiraVez(idSensor) {
        console.log("executei obterDadosGraficoPrimeiraVez" + idSensor)
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }
        fetch(`/funcionarios/ultimas/${idSensor}`, {
                cache: 'no-store'
            }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        resposta.reverse();

                        var dados = {
                            labels: [],
                            datasets: [{
                                    yAxisID: 'usoHD',
                                    label: 'CPU',
                                    borderColor: 'rgb(238, 32, 73)',
                                    backgroundColor: 'rgb(238, 32, 73)',
                                    fill: false,
                                    data: []
                                },
                                {
                                    yAxisID: 'usoHD',
                                    label: 'RAM',
                                    borderColor: 'rgb(30,144,255)',
                                    backgroundColor: 'rgb(30,144,255)',
                                    fill: false,
                                    data: []
                                },
                                {
                                    yAxisID: 'usoHD',
                                    label: 'Disco',
                                    borderColor: 'white',
                                    backgroundColor: 'white',
                                    fill: false,
                                    data: []
                                }
                            ]
                        };

                        for (i = 0; i >= 7; i++) {
                            dados.labels.shift();
                            dados.datasets[0].data.shift();
                            dados.datasets[1].data.shift();
                            dados.datasets[2].data.shift();
                        }
                        for (i = 0; i < resposta.length; i++) {
                            var registro = resposta[i];
                            hostname.innerHTML = registro.Hostname;
                            dados.labels.push(registro.momento_grafico);
                            dados.datasets[0].data.push(registro.usoCPU);
                            dados.datasets[1].data.push(registro.usoRAM);
                            dados.datasets[2].data.push(registro.usoHD);
                        }
                        console.log(JSON.stringify(dados));
                        plotarGrafico(dados, idSensor);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function atualizarGrafico(idSensor, dados) {
        fetch(`/funcionarios/dashboard/${idSensor}`, {
                cache: 'no-store'
            }).then(function (response) {
                console.log("Estou tentando pegar idSensor = ", idSensor)
                if (response.ok) {
                    response.json().then(function (novoRegistro) {

                        console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                        console.log(`Dados atuais do gráfico:`, dados);
                        tempGpu.innerHTML = novoRegistro.temperatura + "°C";
                        tempCpu.innerHTML = novoRegistro.tempC + "°C";
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
                        dados.datasets[0].data.shift();
                        dados.datasets[0].data.push(novoRegistro.usoCPU);
                        dados.datasets[1].data.shift();
                        dados.datasets[1].data.push(novoRegistro.usoRAM);
                        dados.datasets[2].data.shift();
                        dados.datasets[2].data.push(novoRegistro.usoHD);
                        window.lineChart.update();
                        proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados), 5000);

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados), 5000);
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function plotarGrafico(dados, idSensor) {
        console.log("executei plotarGrafico")
        if (cont > 0) {
            lineChart.destroy();
        }
        var ctx2 = document.getElementById('lineChart').getContext('2d');
        window.lineChart = new Chart(ctx2, {
            type: 'line',
            data: dados,
            options: configurarGrafico()
        });
        cont++;
        atualizarGrafico(idSensor, dados);
    }

    function configurarGrafico() {
        console.log("executei configurarGrafico")
        var configuracoes = {
            responsive: true,
            animation: {
                duration: 500
            },
            hoverMode: 'index',
            stacked: false,
            title: {
                display: true,
                text: 'Histórico de temperatura'
            },
            scales: {
                yAxes: [{
                    type: 'linear',
                    display: true,
                    position: 'right',
                    ticks: {
                        beginAtZero: true,
                        min: 0,
                        max: 100,
                        stepsize: 5
                    },
                    id: 'usoHD',
                }, {
                    gridLines: {
                        drawOnChartArea: false,
                    },
                }],
            }
        };

        return configuracoes;
    }

    function redirecionar_email() {
        window.location.href = 'login.html';
    }

    function logoff() {
        sessionStorage.clear();
        window.location.href = 'index.html';
    }
</script>