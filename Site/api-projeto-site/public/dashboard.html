<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="js/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/cores.js"></script>
    <script src="https://kit.fontawesome.com/6f2d70ffaf.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kulim+Park:wght@200;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="img/icone.png" type="image/x-icon">
    <script src="js/validacaoNPJ.js"></script>
    <title>Painel de Controle</title>
</head>

<body>
    <div id="absoluto" class="absoluto">
        <div class="sair">
            <img class="iconSair" src="img/icone.png" alt="">
            <p class="tituloSair">Deseja mesmo sair?</p>
            <div class="lado">
                <button class="btnCancelar" onclick="fechar()">Cancelar</button>
                <button class="btnSair" onclick="logoff()"> Sair</button>
            </div>
        </div>
    </div>
    <section id="dashboardSec" class="dashboard">
        <div class="absolute none" id="abs">
            <i class="fa fa-times fa-2x" onclick="hide()"></i>
            <div class="boxTitulo">
                <p class="txtInfo">Informações Principais</p>
            </div>
            <div class="boxSup">
                <div class="verti">
                    <p class="titInfo">Hostname</p>
                    <p id="hostname" class="Info"></p>
                </div>
                <div class="verti">
                    <p class="titInfo">Temperatura da GPU</p>
                    <p id="tempGpu" class="InfoRed"></p>
                </div>
                <div class="verti">
                    <p class="titInfo">Temperatura da CPU</p>
                    <p id="tempCpu" class="Info"></p>
                </div>
                <div class="verti">
                    <p class="titInfo">Uso da Memória RAM</p>
                    <div class="grafico">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="inf">
                <div class="esq">
                    <div class="boxTituloP">
                        <p class="txtInfo">Grafico de temperatura GPU</p>
                    </div>
                    <div class="listProc">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
                <div class="dir">
                    <div>
                        <div class="boxTituloS">
                            <p class="txtInfo">Status da máquina</p>
                        </div>
                        <div class="divstatus">
                            <i id="icon" class="fas fa-3x"></i>
                            <p id="txtAlert" class="txtAlerta"></p>
                        </div>
                    </div>
                    <div>
                        <div class="boxTituloS">
                            <p class="txtInfo">Lista de processos</p>
                        </div>
                        <div class="ultReg">
                            <div class="titulosProc">
                                <p class="titProc">Nome</p>
                                <p class="titProc">CPU</p>
                                <p class="titProc">PID</p>
                            </div>
                            <div class="painelProc" id="painelProc"></div>
                            <!-- <div class="linha">
                                <p class="infoProc">Discord</p>
                                <p class="infoProc">22%</p>
                                <p class="infoProc">34232</p>
                            </div>
                            <div class="linha">
                                <p class="infoProc">Discord</p>
                                <p class="infoProc">22%</p>
                                <p class="infoProc">34232</p>
                            </div>
                            <div class="linha">
                                <p class="infoProc">Discord</p>
                                <p class="infoProc">22%</p>
                                <p class="infoProc">34232</p>
                            </div> -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="menulateral">
            <div class="topo">
                <img class="logo" src="img/logo.png" alt="">
                <img class="iconempresa" src="img/icon.png" alt="">
                <p class="nomeempresa" id="nome_EmpresaD"></p>
                <p class="cnpjempresa" id="cnpj_EmpresaD">CNPJ: </p>
            </div>
            <div class="botoes">
                <button class="btn destaque" onclick="dashboard()"><i class="fas fa-tv"></i>Computadores</button>
                <button class="btn" onclick="config()"><i class="fas fa-cog"></i>Configurações</button>
                <button class="btn" onclick="usuario()"><i class="fas fa-user-plus"></i>Usuário</button>
            </div>
            <button class="btn btn-sair" onclick="sair()"><i class="fas fa-sign-out-alt"></i>Sair</button>
        </div>
        <div class="ladoEsquerdo">
            <div class="superior">
                <div class="pesquisa">
                    <input type="text" class="pesquisacampo" placeholder="Pesquisar">
                    <button type="submit" class="pesquisabtn">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
                <div class="notifica">
                    <i class="far fa-bell"></i>
                    <div class="numero">3</div>
                </div>
            </div>
            <div class="inferior">
                <p class="tituloStatus">Status dos computadores</p>
                <div class="boxes">
                    <div class="box">
                        <p class="txt Normal">Normal</p>
                        <p class="qtdeComp" id="qtdNormal"></p>
                    </div>
                    <div class="box">
                        <p class="txt Alerta">Alerta</p>
                        <p class="qtdeComp" id="qtdAlerta"></p>
                    </div>
                    <div class="box">
                        <p class="txt Critico">Crítico</p>
                        <p class="qtdeComp" id="qtdCritico"></p>
                    </div>
                </div>
                <div class="computadores">
                    <p class="tituloStatus">Computadores</p>
                    <div id="boxes" class="boxes">
                        <!-- <div class="boxComp" onclick="'show(1)'">
                            <p class="nomeComp">Computador 1</p>
                            <p class="nomeResponsavel">Responsavel</p>
                            <p class="txtEstado Alerta">Alerta</p>
                            <i class="fas fa-exclamation-triangle fa-3x"></i>
                            <div class="horiz">
                                <div class="vert">
                                    <p class="txtHard">GPU</p>
                                    <p id="gpu1" class="temp">65°C</p>
                                </div>
                                <div class="vert">
                                    <p class="txtHard">CPU</p>
                                    <p id="cpu1" class="temp">54°C</p>
                                </div>
                                <div class="vert">
                                    <p class="txtHard">RAM</p>
                                    <p id="ram1" class="ram">5.4GB</p>
                                </div>
                            </div>
                        </div>
                        <div class="boxComp" onclick="show(2)">
                            <p class="nomeComp">Computador 2</p>
                            <p class="nomeResponsavel">Responsavel</p>
                            <p class="txtEstado Critico">Critico</p>
                            <i class="fas fa-exclamation-circle fa-3x"></i>
                            <div class="horiz">
                                <div class="vert">
                                    <p class="txtHard">GPU</p>
                                    <p id="gpu2" class="temp">94°C</p>
                                </div>
                                <div class="vert">
                                    <p class="txtHard">CPU</p>
                                    <p id="cpu2" class="temp">96°C</p>
                                </div>
                                <div class="vert">
                                    <p class="txtHard">RAM</p>
                                    <p id="ram2" class="ram">7.4GB</p>
                                </div>
                            </div>
                        </div>
                        <div class="boxComp" onclick="show(3)">
                            <p class="nomeComp">Computador 3</p>
                            <p class="nomeResponsavel">Responsavel</p>
                            <p class="txtEstado Normal">Normal</p>
                            <i class="fas fa-check-circle fa-3x"></i>
                            <div class="horiz">
                                <div class="vert">
                                    <p class="txtHard">GPU</p>
                                    <p id="gpu3" class="temp">52°C</p>
                                </div>
                                <div class="vert">
                                    <p class="txtHard">CPU</p>
                                    <p id="cpu3" class="temp">47°C</p>
                                </div>
                                <div class="vert">
                                    <p class="txtHard">RAM</p>
                                    <p id="ram3" class="ram">3.0GB</p>
                                </div>
                            </div> 
                        </div>-->
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="configSec" class="config none">
        <div class="menulateral">
            <div class="topo">
                <img class="logo" src="img/logo.png" alt="">
                <img class="iconempresa" src="img/icon.png" alt="">
                <p class="nomeempresa" id="nome_EmpresaC"></p>
                <p class="cnpjempresa" id="cnpj_EmpresaC">CNPJ: </p>
            </div>
            <div class="botoes">
                <button class="btn" onclick="dashboard()"><i class="fas fa-tv"></i>Computadores</button>
                <button class="btn destaque" onclick="config()"><i class="fas fa-cog"></i>Configurações</button>
                <button class="btn" onclick="usuario()"><i class="fas fa-user-plus"></i>Usuário</button>
            </div>
            <button class="btn btn-sair" onclick="sair()"><i class="fas fa-sign-out-alt"></i>Sair</button>
        </div>
        <div class="ladoEsquerdo">
            <div class="configuracoes">
                <p class="tituloConfig">CONFIGURAÇÕES</p>
                <form id="form_atualizar" method="post" onsubmit="return atualizar()">
                    <div class="forms">
                        <div>
                            <p>Nome empresa</p>
                            <input name="nomeEmpresa" type="text" id="nomeEmpresaInput">
                        </div>
                        <div>
                            <p>Email</p>
                            <input name="emailEmpresa" type="text" id="emailEmpresaInput">
                        </div>
                    </div>
                    <div class="forms">
                        <div>
                            <p>CNPJ</p>
                            <input onkeyup="validarcnpj()" name="cnpjEmpresa" type="text" id="cnpjEmpresaInput">
                        </div>
                        <div>
                            <p>WhatsApp</p>
                            <input name="whatsEmpresa" type="text" id="whatsEmpresaInput">
                        </div>
                    </div>
                    <div class="linhaConfig"></div>
                    <div class="forms">
                        <div>
                            <p>CEP</p>
                            <input name="cepEmpresa" type="text" id="cepEmpresaInput">
                        </div>
                        <div>
                            <p>Estado</p>
                            <input name="estadoEmpresa" type="text" id="estadoEmpresaInput">
                        </div>
                    </div>
                    <div class="forms">
                        <div>
                            <p>Cidade</p>
                            <input name="cidadeEmpresa" type="text" id="cidadeEmpresaInput">
                        </div>
                        <div>
                            <p>Logradouro</p>
                            <input name="logradouroEmpresa" type="text" id="logradouroEmpresaInput">
                        </div>
                    </div>
                    <div class="linhaConfig"></div>
                    <div class="slack">
                        <p>Url Slack</p>
                        <input name="urlSlack" type="text" id="urlSlackInput">
                    </div>
                    <button class="btnSave">Salvar alterações</button>
                </form>
            </div>
        </div>
    </section>
    <section id="novoUsu" class="novoUsu none">
        <!-- <div id="addUsu">
            <form id="form_empresa" method="post" onsubmit="return cadastrar_empresa()">
                <p class="tituloAddUsu">Novo Usuário</p>
                <div class="supAddUsu">
                    <p>Nome Completo</p>
                    <input type="text" name="" id="">
                    <p>Hostname</p>
                    <input type="text" name="" id="">
                </div>
                <div class="infAddUsu">
                    <p>Login</p>
                    <input type="text" name="" id="">
                    <p>Login</p>
                    <input type="text" name="" id="">
                </div>
            </form>
        </div> -->
        <div class="menulateral">
            <div class="topo">
                <img class="logo" src="img/logo.png" alt="">
                <img class="iconempresa" src="img/icon.png" alt="">
                <p class="nomeempresa" id="nome_EmpresaN"></p>
                <p class="cnpjempresa" id="cnpj_EmpresaN">CNPJ: </p>
            </div>
            <div class="botoes">
                <button class="btn" onclick="dashboard()"><i class="fas fa-tv"></i>Computadores</button>
                <button class="btn" onclick="config()"><i class="fas fa-cog"></i>Configurações</button>
                <button class="btn destaque" onclick="usuario()"><i class="fas fa-user-plus"></i>Usuário</button>
            </div>
            <button class="btn btn-sair" onclick="sair()"><i class="fas fa-sign-out-alt"></i>Sair</button>
        </div>
        <div class="ladoEsquerdo">
            <div class="superior">
                <div class="pesquisa">
                    <input type="text" class="pesquisacampo" placeholder="Pesquisar">
                    <button type="submit" class="pesquisabtn">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
                <div class="notifica">
                    <i class="far fa-bell"></i>
                    <div class="numero">3</div>
                </div>
            </div>
            <div class="inferior">
                <div class="funcUsuarios">
                    <div class="txtCentr">
                        <p><i class="fa fa-plus-circle" aria-hidden="true"></i>Novo Usuário</p>
                        <p><i class="fa fa-minus-circle" aria-hidden="true"></i>Remover Usuário</p>
                        <p><i class="fa fa-pencil-square-o" aria-hidden="true"></i>Editar Usuário</p>
                    </div>
                </div>
                <div class="tituloUsuarios">
                    <div class="txtCentr2">
                        <p>Nome Completo</p>
                        <p>E-mail</p>
                        <p>Hostname</p>
                    </div>
                </div>
                <div class="infoUsuarios">
                    <div id="linhasUsuarios" class="linhasUsuarios">
                    </div>
                </div>
            </div>

    </section>
</body>

</html>
<script>
    let proximaAtualizacao;
    window.onload = verificar_autenticacao();
    var cont = 0;
    function obterFuncionarios() {
        var idEmpresa = sessionStorage.idEmpresa;
        fetch(`/funcionarios/${idEmpresa}`)
            .then(resposta => {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        console.log(`Dados dos funcionarios recebidos: ${JSON.stringify(resposta)}`);
                        atualizarFuncionarios(resposta);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção das publicações: ${error.message}`);
            });
    }
    function medias(tempCP, tempGP, usoRamP, id, iconEstado) {
        fetch(`/funcionarios/media/${id}`)
            .then(resposta => {
                if (resposta.ok) {
                    resposta.json().then(function (medias) {
                        caio = JSON.parse(JSON.stringify(medias[0]));
                        console.log(caio.mediaCPU);
                        console.log(caio.mediaGPU);
                        console.log(caio.mediaRAM);
                        tempCP.innerHTML = caio.mediaCPU;
                        tempGP.innerHTML = caio.mediaGPU
                        usoRamP.innerHTML = caio.mediaRAM;
                        cores(usoRamP, tempGP, tempCP, iconEstado);
                        tempCP.innerHTML += "°C";
                        tempGP.innerHTML += "°C";
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }

            })

            .catch(function (error) {
                console.error(`Erro na obtenção das publicações: ${error.message}`);
            });

    }
    function atualizarFuncionarios(funcionarios) {
        var painel = document.getElementById("linhasUsuarios");
        var painelBoxes = document.getElementById("boxes")
        for (let i = 0; i < funcionarios.length; i++) {
            var funcionario = funcionarios[i];
            var hostname = funcionario.Hostname;
            var nome = funcionario.Nome;
            var sobrenome = funcionario.Sobrenome;
            var email = funcionario.email;
            var id = funcionario.idMaquina;

            var divAux = document.createElement("div")
            var divLinha = document.createElement("div")
            var checkbox = document.createElement("input")
            var NomeP = document.createElement("p")
            var emailP = document.createElement("p")
            var HostnameP = document.createElement("p")

            var box = document.createElement("div");
            var computadorP = document.createElement("p");
            var responsavelP = document.createElement("p");
            var estadoP = document.createElement("p");
            var iconEstado = document.createElement("i");
            var divHoriz = document.createElement("div");
            var divVert = document.createElement("div");
            var divVert2 = document.createElement("div");
            var divVert3 = document.createElement("div");
            var CPUP = document.createElement("p");
            var RAMP = document.createElement("p");
            var GPUP = document.createElement("p");
            var tempCP = document.createElement("p");
            var tempGP = document.createElement("p");
            var usoRamP = document.createElement("p");
            tempCP.setAttribute('id', 'tempCP');
            usoRamP.setAttribute('id', 'usoRamP');
            tempGP.setAttribute('id', 'tempGP');
            medias(tempCP, tempGP, usoRamP, id, iconEstado);
            checkbox.type = "radio";
            checkbox.value = funcionario.idMaquina;
            checkbox.name = "group";
            NomeP.innerHTML = nome + " " + sobrenome;
            emailP.innerHTML = email;
            HostnameP.innerHTML = hostname;
            var numPC = i + 1;
            computadorP.innerHTML = "Computador " + numPC;
            responsavelP.innerHTML = nome;
            CPUP.innerHTML = "CPU";
            RAMP.innerHTML = "RAM";
            GPUP.innerHTML = "GPU";

            box.setAttribute("onclick", `show(${funcionario.idMaquina})`)
            divAux.className = "divAux";
            checkbox.className = "checkbox";
            divLinha.className = "linhaUsuarios";
            NomeP.className = "nome";
            emailP.className = "email";

            box.className = "boxComp";
            computadorP.className = "nomeComp";
            responsavelP.className = "nomeResponsavel";
            CPUP.className = "txtHard";
            RAMP.className = "txtHard";
            GPUP.className = "txtHard";
            divVert.className = "vert";
            divVert2.className = "vert";
            divVert3.className = "vert";
            divHoriz.className = "horiz";
            tempCP.className = "temp";
            tempGP.className = "temp";
            usoRamP.className = "ram";

            divVert.appendChild(GPUP);
            divVert2.appendChild(CPUP);
            divVert3.appendChild(RAMP);
            divVert.appendChild(tempGP);
            divVert2.appendChild(tempCP);
            divVert3.appendChild(usoRamP);

            divHoriz.appendChild(divVert);
            divHoriz.appendChild(divVert2);
            divHoriz.appendChild(divVert3);
            box.appendChild(computadorP);
            box.appendChild(responsavelP);
            box.appendChild(estadoP);
            box.appendChild(iconEstado);
            box.appendChild(divHoriz);
            painelBoxes.appendChild(box);

            divAux.appendChild(NomeP);
            divAux.appendChild(emailP);
            divAux.appendChild(HostnameP);
            divLinha.appendChild(checkbox);
            divLinha.appendChild(divAux);
            painel.appendChild(divLinha);

        }
        total();
    }
    function sair() {
        absoluto.style = "display: flex;";
    }
    function fechar() {
        absoluto.style = "display: none;";
    }
    function dashboard() {
        configSec.classList.add('none');
        novoUsu.classList.add('none');
        dashboardSec.classList.remove('none');
    }
    function config() {
        configSec.classList.remove('none');
        dashboardSec.classList.add('none');
        novoUsu.classList.add('none');
    }
    function usuario() {
        configSec.classList.add('none');
        dashboardSec.classList.add('none');
        novoUsu.classList.remove('none');
    }
    function chart() {
        var ctx = document.getElementById('myChart').getContext('2d');
        window.myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0.0, 0.0],
                    backgroundColor: [
                        'rgb(255, 0, 0)',
                        'rgba(255, 255, 255, 0)'
                    ],
                    hoverOffset: 1
                }]
            },
            radius: 50
        });
    }
    function update(numero) {
        fetch(`/funcionarios/ram/${numero}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (Registro) {
                    myChart.data.datasets[0].data.shift();
                    myChart.data.datasets[0].data.shift();
                    var resto = Registro.qntRAM - Registro.usoRAM;
                    myChart.data.datasets[0].data.push(Registro.usoRAM.toFixed(1));
                    myChart.data.datasets[0].data.push(resto.toFixed(1));
                    myChart.update();
                    console.log("O id é: " + numero);
                    obterDadosGraficoPrimeiraVez(numero);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    function processos(numero) {
        fetch(`/funcionarios/processos/${numero}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (processos) {
                    var painelProc = document.getElementById("painelProc");
                    for (let i = 0; i < processos.length; i++) {
                        var processo = processos[i];
                        var nome = processo.nomeProcesso;
                        var usoCPU = processo.usoCPU;
                        var pid = processo.PID;
                        var linha = document.createElement("div");
                        var nomeProc = document.createElement("p");
                        var usoCPUP = document.createElement("p");
                        var pidP = document.createElement("p");
                        nomeProc.innerHTML = nome;
                        usoCPUP.innerHTML = usoCPU + "%";
                        pidP.innerHTML = pid;
                        linha.setAttribute('id', 'linha');
                        linha.className = "linha";
                        nomeProc.className = "infoProc";
                        usoCPUP.className = "infoProc";
                        pidP.className = "infoProc";
                        linha.appendChild(nomeProc);
                        linha.appendChild(usoCPUP);
                        linha.appendChild(pidP);
                        painelProc.appendChild(linha);
                    }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    function remove() {
        for (let i = 0; i < 3; i++) {
            var linha = document.getElementById("linha");
            if (linha != null) {
                linha.remove();
            }
        }
    }
    function verificar_autenticacao() {
        var nome = document.getElementById('nomeEmpresaInput');
        var email = document.getElementById('emailEmpresaInput');
        var cnpj = document.getElementById('cnpjEmpresaInput');
        var whats = document.getElementById('whatsEmpresaInput');
        var cep = document.getElementById('cepEmpresaInput');
        var estado = document.getElementById('estadoEmpresaInput');
        var cidade = document.getElementById('cidadeEmpresaInput');
        var logradouro = document.getElementById('logradouroEmpresaInput');
        var urlSlack = document.getElementById('urlSlackInput');
        chart();
        let nomeEmpresa;
        let cnpjEmpresa;
        let emailEmpresa;
        let whatsEmpresa;
        let cepEmpresa;
        let estadoEmpresa;
        let cidadeEmpresa;
        let logradouroEmpresa;
        let urlSlackEmpresa;

        nomeEmpresa = sessionStorage.nomeEmpresa;
        cnpjEmpresa = sessionStorage.cnpjEmpresa;
        emailEmpresa = sessionStorage.emailEmpresa;
        whatsEmpresa = sessionStorage.whatsEmpresa;
        cepEmpresa = sessionStorage.cepEmpresa;
        estadoEmpresa = sessionStorage.estadoEmpresa;
        cidadeEmpresa = sessionStorage.cidadeEmpresa;
        logradouroEmpresa = sessionStorage.logradouroEmpresa;
        urlSlackEmpresa = sessionStorage.urlSlack;

        if (nomeEmpresa == undefined) {
            redirecionar_email();
        } else {
            obterFuncionarios();
            nome.value += `${nomeEmpresa}`;
            email.value += `${emailEmpresa}`;
            cnpj.value += `${cnpjEmpresa}`;
            whats.value += `${whatsEmpresa}`;
            cep.value += `${cepEmpresa}`;
            estado.value += `${estadoEmpresa}`;
            cidade.value += `${cidadeEmpresa}`;
            logradouro.value += `${logradouroEmpresa}`;
            urlSlack.value += `${urlSlackEmpresa}`;
            nome_EmpresaD.innerHTML += `${nomeEmpresa}`;
            nome_EmpresaC.innerHTML += `${nomeEmpresa}`;
            nome_EmpresaN.innerHTML += `${nomeEmpresa}`;
            cnpj_EmpresaD.innerHTML += `${cnpjEmpresa}`;
            cnpj_EmpresaC.innerHTML += `${cnpjEmpresa}`;
            cnpj_EmpresaN.innerHTML += `${cnpjEmpresa}`;

        }
        validar_sessao()
    }
    function validar_sessao() {
        var emailEmpresa = sessionStorage.emailEmpresa;
        fetch(`/empresas/sessao/${emailEmpresa}`, { cache: 'no-store' })
            .then(resposta => {
                if (resposta.ok) {
                    resposta.text().then(texto => {
                        console.log('Sessão :) ', texto);
                    });
                } else {
                    console.error('Sessão :.( ');
                    logoff();
                }
            });
    }
    function atualizar() {
        var nome = document.getElementById('nomeEmpresaInput');
        var cnpj = document.getElementById('cnpjEmpresaInput');
        var idEmpresa = sessionStorage.idEmpresa;
        var formulario1 = new URLSearchParams(new FormData(form_atualizar));
        fetch(`/empresas/atualizar/${idEmpresa}`, {
            method: "POST",
            body: formulario1
        }).then(function (resultado) {
            if (resultado.ok) {
                console.log('Atualizado com sucesso');
                nome_EmpresaD.innerHTML = `${nome.value}`;
                nome_EmpresaC.innerHTML = `${nome.value}`;
                nome_EmpresaN.innerHTML = `${nome.value}`;
                cnpj_EmpresaD.innerHTML = `CNPJ: ${cnpj.value}`;
                cnpj_EmpresaC.innerHTML = `CNPJ: ${cnpj.value}`;
                cnpj_EmpresaN.innerHTML = `CNPJ: ${cnpj.value}`;
                sessionStorage.nomeEmpresa = nome.value;
                sessionStorage.cnpjEmpresa = cnpj.value;

            } else {
                console.log('Erro de atualização!');
                response.text().then(function (resultado) {
                });
            }
        });

        return false;
    }
    function obterDadosGraficoPrimeiraVez(idSensor) {
        console.log("executei obterDadosGraficoPrimeiraVez" + idSensor)
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }
        fetch(`/funcionarios/ultimas/${idSensor}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    var dados = {
                        labels: [],
                        datasets: [
                            {
                                yAxisID: 'y-temperatura',
                                label: 'Temperatura',
                                borderColor: 'rgba(255,0,0,1)',
                                backgroundColor: 'rgba(255,0,0,1)',
                                fill: false,
                                data: []
                            }
                        ]
                    };

                    for (i = 0; i >= 7; i++) {
                        dados.labels.shift();
                        dados.datasets[0].data.shift();
                    }
                    for (i = 0; i < resposta.length; i++) {
                        var registro = resposta[i];
                        hostname.innerHTML = registro.Hostname;
                        dados.labels.push(registro.momento_grafico);
                        dados.datasets[0].data.push(registro.temperatura);
                    }
                    console.log(JSON.stringify(dados));
                    plotarGrafico(dados, idSensor);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
    function atualizarGrafico(idSensor, dados) {
        fetch(`/funcionarios/dashboard/${idSensor}`, { cache: 'no-store' }).then(function (response) {
            console.log("Estou tentando pegar idSensor = ", idSensor)
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`, dados);
                    tempGpu.innerHTML = novoRegistro.temperatura + "°C";
                    tempCpu.innerHTML = novoRegistro.tempC + "°C";
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
                    dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[0].data.push(novoRegistro.temperatura); // incluir uma nova leitura de temperatura
                    window.lineChart.update();
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados), 5000);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados), 5000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
    function plotarGrafico(dados, idSensor) {
        console.log("executei plotarGrafico")
        if (cont > 0) {
            lineChart.destroy();
        }
        var ctx2 = document.getElementById('lineChart').getContext('2d');
        window.lineChart = new Chart(ctx2, {
            type: 'line',
            data: dados,
            options: configurarGrafico()
        });
        cont++;
        atualizarGrafico(idSensor, dados);
    }
    function configurarGrafico() {
        console.log("executei configurarGrafico")
        var configuracoes = {
            responsive: true,
            animation: { duration: 500 },
            hoverMode: 'index',
            stacked: false,
            title: {
                display: true,
                text: 'Histórico de temperatura'
            },
            scales: {
                yAxes: [{
                    type: 'linear',
                    display: true,
                    position: 'right',
                    ticks: {
                        min: 0,
                        max: 50,
                        stepsize: 1
                    },
                    id: 'y-temperatura',
                }, {
                    gridLines: {
                        drawOnChartArea: false,
                    },
                }],
            }
        };

        return configuracoes;
    }
    function redirecionar_email() {
        window.location.href = 'login.html';
    }
    function logoff() {
        sessionStorage.clear();
        window.location.href = 'index.html';
    }
</script>